// ============================================================================
// Monvie Admin - Prisma Schema
// Database: PostgreSQL
// Convention: camelCase in Prisma, snake_case in DB via @map / @@map
// ============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// 1. customers
// ============================================================================
model Customer {
  id             String   @id @default(uuid()) @db.Uuid
  email          String   @unique
  name           String?
  phone          String?
  country        String   @default("KR")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")
  totalOrders    Int      @default(0) @map("total_orders")
  totalSpent     Decimal  @default(0) @map("total_spent") @db.Decimal(12, 2)
  lastActivityAt DateTime? @map("last_activity_at")

  // Relations
  designSessions     DesignSession[]
  cartItems          CartItem[]
  orders             Order[]
  funnelEvents       FunnelEvent[]
  recoveryCampaigns  RecoveryCampaign[]

  @@map("customers")
}

// ============================================================================
// 2. design_sessions
// ============================================================================
model DesignSession {
  id                   String    @id @default(uuid()) @db.Uuid
  customerId           String    @map("customer_id") @db.Uuid
  sessionToken         String    @map("session_token")
  themeId              String    @map("theme_id")
  status               String    @default("started")
  photoCount           Int       @default(0) @map("photo_count")
  hasCustomText        Boolean   @default(false) @map("has_custom_text")
  designData           Json?     @map("design_data")
  previewUrl           String?   @map("preview_url")
  totalEditTimeSeconds Int       @default(0) @map("total_edit_time_seconds")
  lastActivityAt       DateTime? @map("last_activity_at")
  abandonedAt          DateTime? @map("abandoned_at")
  recoveryEmailSentAt  DateTime? @map("recovery_email_sent_at")
  recoveryEmailCount   Int       @default(0) @map("recovery_email_count")
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")

  // Relations
  customer   Customer    @relation(fields: [customerId], references: [id])
  cartItems  CartItem[]
  orderItems OrderItem[]
  funnelEvents FunnelEvent[]

  // Indexes
  @@index([status])
  @@index([customerId], map: "idx_design_sessions_customer_id")
  @@index([abandonedAt], map: "idx_design_sessions_abandoned_at")

  @@map("design_sessions")
}

// ============================================================================
// 3. cart_items
// ============================================================================
model CartItem {
  id                  String    @id @default(uuid()) @db.Uuid
  customerId          String    @map("customer_id") @db.Uuid
  designSessionId     String    @map("design_session_id") @db.Uuid
  themeId             String    @map("theme_id")
  quantity            Int       @default(1)
  unitPrice           Decimal   @map("unit_price") @db.Decimal(12, 2)
  currency            String    @default("KRW")
  status              String    @default("active")
  addedAt             DateTime  @default(now()) @map("added_at")
  abandonedAt         DateTime? @map("abandoned_at")
  recoveryEmailSentAt DateTime? @map("recovery_email_sent_at")
  recoveryEmailCount  Int       @default(0) @map("recovery_email_count")

  // Relations
  customer       Customer       @relation(fields: [customerId], references: [id])
  designSession  DesignSession  @relation(fields: [designSessionId], references: [id])

  // Indexes
  @@index([status])
  @@index([abandonedAt], map: "idx_cart_items_abandoned_at")

  @@map("cart_items")
}

// ============================================================================
// 4. orders
// ============================================================================
model Order {
  id                  String    @id @default(uuid()) @db.Uuid
  orderNumber         String    @unique @map("order_number")
  customerId          String    @map("customer_id") @db.Uuid
  status              String    @default("paid")
  subtotal            Decimal   @db.Decimal(12, 2)
  shippingFee         Decimal   @default(0) @map("shipping_fee") @db.Decimal(12, 2)
  discount            Decimal   @default(0) @db.Decimal(12, 2)
  total               Decimal   @db.Decimal(12, 2)
  currency            String    @default("KRW")
  paymentMethod       String?   @map("payment_method")
  paymentId           String?   @map("payment_id")
  shippingAddress     Json?     @map("shipping_address")
  trackingNumber      String?   @map("tracking_number")
  carrier             String?
  estimatedDeliveryAt DateTime? @map("estimated_delivery_at")
  shippedAt           DateTime? @map("shipped_at")
  deliveredAt         DateTime? @map("delivered_at")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  // Relations
  customer   Customer    @relation(fields: [customerId], references: [id])
  orderItems OrderItem[]

  // Indexes
  @@index([status])
  @@index([createdAt], map: "idx_orders_created_at")

  @@map("orders")
}

// ============================================================================
// 5. order_items
// ============================================================================
model OrderItem {
  id               String   @id @default(uuid()) @db.Uuid
  orderId          String   @map("order_id") @db.Uuid
  designSessionId  String   @map("design_session_id") @db.Uuid
  themeId          String   @map("theme_id")
  quantity         Int      @default(1)
  unitPrice        Decimal  @map("unit_price") @db.Decimal(12, 2)
  productionStatus String   @default("pending") @map("production_status")
  productionFileUrl String? @map("production_file_url")
  createdAt        DateTime @default(now()) @map("created_at")

  // Relations
  order         Order         @relation(fields: [orderId], references: [id])
  designSession DesignSession @relation(fields: [designSessionId], references: [id])

  @@map("order_items")
}

// ============================================================================
// 6. funnel_events
// ============================================================================
model FunnelEvent {
  id              String    @id @default(uuid()) @db.Uuid
  customerId      String?   @map("customer_id") @db.Uuid
  sessionId       String    @map("session_id")
  designSessionId String?   @map("design_session_id") @db.Uuid
  eventType       String    @map("event_type")
  metadata        Json?
  createdAt       DateTime  @default(now()) @map("created_at")

  // Relations
  customer       Customer?      @relation(fields: [customerId], references: [id])
  designSession  DesignSession? @relation(fields: [designSessionId], references: [id])

  // Indexes
  @@index([eventType], map: "idx_funnel_events_event_type")
  @@index([createdAt], map: "idx_funnel_events_created_at")
  @@index([customerId], map: "idx_funnel_events_customer_id")

  @@map("funnel_events")
}

// ============================================================================
// 7. recovery_campaigns
// ============================================================================
model RecoveryCampaign {
  id             String    @id @default(uuid()) @db.Uuid
  customerId     String    @map("customer_id") @db.Uuid
  campaignType   String    @map("campaign_type")
  targetId       String    @map("target_id") @db.Uuid
  emailSentAt    DateTime? @map("email_sent_at")
  emailOpenedAt  DateTime? @map("email_opened_at")
  linkClickedAt  DateTime? @map("link_clicked_at")
  convertedAt    DateTime? @map("converted_at")
  discountCode   String?   @map("discount_code")
  attemptNumber  Int       @default(1) @map("attempt_number")
  createdAt      DateTime  @default(now()) @map("created_at")

  // Relations
  customer Customer @relation(fields: [customerId], references: [id])

  // Indexes
  @@index([campaignType], map: "idx_recovery_campaigns_campaign_type")
  @@index([customerId], map: "idx_recovery_campaigns_customer_id")

  @@map("recovery_campaigns")
}

// ============================================================================
// admin_users (authentication)
// ============================================================================
model AdminUser {
  id           String    @id @default(uuid()) @db.Uuid
  email        String    @unique
  name         String
  passwordHash String    @map("password_hash")
  role         String    @default("viewer")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  lastLoginAt  DateTime? @map("last_login_at")

  @@map("admin_users")
}

// ============================================================================
// daily_stats (pre-aggregated analytics)
// ============================================================================
model DailyStat {
  id              String   @id @default(uuid()) @db.Uuid
  date            DateTime @unique @db.Date
  totalRevenue    Decimal  @default(0) @map("total_revenue") @db.Decimal(14, 2)
  totalOrders     Int      @default(0) @map("total_orders")
  conversionRate  Decimal  @default(0) @map("conversion_rate") @db.Decimal(5, 4)
  themeBreakdown  Json?    @map("theme_breakdown")
  recoveryStats   Json?    @map("recovery_stats")
  createdAt       DateTime @default(now()) @map("created_at")

  @@map("daily_stats")
}
